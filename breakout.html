<html>
<head>
    <style>
        canvas {
            border: 1px black solid;
        }
    </style>
    <script src='game.js'></script>
    <script src='paddle.js'></script>
    <script src='block.js'></script>
    <script src='ball.js'></script>
    <script src='level.js'></script>
    <script src='utils.js'></script>
</head>
<body>
    <canvas id="id-canvas" width="400" height="300"></canvas>
    <input type='range' min=1></input>
    <script>
        var __main = function(){
            // 设置 fps 默认值
            window.fps = 100

            // 初始化对象
            var paddle = Paddle()
            var game = Game()
            var ball = Ball()

            // 设置暂停初始值
            var pause = false

            // 载入默认关卡
            var level = 1
            var blocks = loadLevel(level)

            //  注册按键及响应事件
            game.registerAction(['a', 'ArrowLeft'], function(){
                paddle.moveLeft()
            })
            game.registerAction(['d', 'ArrowRight'], function(){
                paddle.moveRight()
            })
            game.registerAction(['f'], function(){
                ball.fire()
            })
            window.addEventListener('keydown', function(event){
                // 暂停和恢复功能
                console.log(event);
                if (event.key === 'p'){
                    pause = !pause
                }
                // 载入新关卡
                var l = Number(event.key)
                var l_max = levels.length
                if (0 < l && l < l_max + 1){
                    level = l
                    console.log(level);
                    blocks = loadLevel(level)
                } else if (l > l_max) {
                    alert(`没有第${l}关卡！(关卡最大为${l_max})`)
                }
            })

            //  fps 绑定滑动条
            var f = document.querySelector('input')
            f.addEventListener('change', function(event){
                console.log('change');
                window.fps = Number(document.querySelector('input').value)
            })

            game.update = function(){
                if (pause === true){
                    return
                }
                ball.move()
                // 判断相撞
                if (paddle.collide(ball) === true){
                    ball.rebound()
                }
                for (var i = 0; i < blocks.length; i++){
                    var b = blocks[i]
                    if (b.collide(ball) === true){
                        ball.rebound()
                        b.hit()
                        console.log(b);
                    }
                }
            }
            game.draw = function(){
                game.drawImg(paddle)
                game.drawImg(ball)

                // draw blocks
                for (var i = 0; i < blocks.length; i++){
                    var b = blocks[i]
                    if (b.alive){
                        game.drawImg(b)
                    }
                }
            }
        }

        __main()
    </script>
</body>
</html>
